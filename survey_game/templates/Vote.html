<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ poll.name }} - Опрос</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'Vote.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <div class="header">
            <h1 class="poll-title">{{ poll.name }}</h1>
            <p class="poll-subtitle">Пожалуйста, оцените каждый вопрос по 5-балльной шкале</p>
        </div>

        <div class="progress-container">
            <div class="progress-text">
                <span>Прогресс заполнения</span>
                <span id="progress-percentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            <div class="progress-stats">
                Отвечено: <span id="answered-count">0</span> из <span id="total-questions">{{ questions|length }}</span> вопросов
            </div>
        </div>

        <form method="post" id="poll-form">
            {% csrf_token %}
            <div class="questions-container">
                {% for q in questions %}
                <div class="question-card" data-question-id="{{ q.id }}">
                    <div class="question-number">{{ forloop.counter }}</div>
                    <p class="question-text">{{ q.text }}</p>
                    <div class="rating-container">
                        {% for i in "12345" %}
                        <div class="rating-option">
                            <input type="radio" name="rating_{{ q.id }}" value="{{ i }}"
                                   id="rating_{{ q.id }}_{{ i }}" class="rating-input question-radio"
                                   data-question-id="{{ q.id }}">
                            <label for="rating_{{ q.id }}_{{ i }}" class="rating-label">
                                <i class="fas fa-star"></i>
                            </label>
                            <span class="rating-value">{{ i }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <button type="submit" class="submit-btn">
                <i class="fas fa-paper-plane"></i> Отправить ответы
            </button>
        </form>

        <a href="/" class="back-link">← Вернуться к списку опросов</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const radioButtons = document.querySelectorAll('.question-radio');
            const progressFill = document.getElementById('progress-fill');
            const progressPercentage = document.getElementById('progress-percentage');
            const answeredCountElement = document.getElementById('answered-count');
            const totalQuestions = {{ questions|length }};
            const answeredQuestions = new Set();
            const form = document.getElementById('poll-form');

            // Функция обновления прогресса
            function updateProgress() {
                const answered = answeredQuestions.size;
                const percentage = Math.round((answered / totalQuestions) * 100);

                progressFill.style.width = percentage + '%';
                progressPercentage.textContent = percentage + '%';
                answeredCountElement.textContent = answered;

                if (percentage < 30) {
                    progressFill.style.background = "#e74c3c";
                } else if (percentage < 70) {
                    progressFill.style.background = "#f39c12";
                } else if (percentage < 100) {
                    progressFill.style.background = "#3498db";
                } else {
                    progressFill.style.background = "linear-gradient(90deg, #4b6cb7 0%, #182848 100%)";
                }
            }

            // Обработчик для радио-кнопок
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    const questionId = this.getAttribute('data-question-id');
                    answeredQuestions.add(questionId);
                    updateProgress();
                });
            });

            // Проверяем предзаполненные ответы
            function checkInitialAnswers() {
                radioButtons.forEach(radio => {
                    if (radio.checked) {
                        const questionId = radio.getAttribute('data-question-id');
                        answeredQuestions.add(questionId);
                    }
                });
                updateProgress();
            }

            // Инициализация
            checkInitialAnswers();

            // Обработчик отправки формы
            form.addEventListener('submit', function(e) {
                // Сохраняем исходное состояние кнопки
                const submitBtn = document.querySelector('.submit-btn');
                const originalHTML = submitBtn.innerHTML;
                const originalDisabled = submitBtn.disabled;

                // Меняем кнопку на состояние загрузки
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
                submitBtn.disabled = true;

                // Проверяем, все ли вопросы отвечены
                if (answeredQuestions.size < totalQuestions) {
                    // Показываем диалог подтверждения
                    const userConfirmed = confirm(
                        `Вы ответили на ${answeredQuestions.size} из ${totalQuestions} вопросов. Всё равно отправить?`
                    );

                    if (!userConfirmed) {
                        // Если пользователь нажал "Отмена"
                        // Восстанавливаем кнопку и предотвращаем отправку
                        e.preventDefault();
                        submitBtn.innerHTML = originalHTML;
                        submitBtn.disabled = originalDisabled;
                        console.log('Пользователь отменил отправку формы');
                        return;
                    }
                    // Если пользователь нажал "OK" - форма отправится
                    console.log('Пользователь подтвердил отправку неполной формы');
                } else {
                    console.log('Все вопросы отвечены, отправка формы');
                }

                // Автоматически восстанавливаем кнопку через 5 секунд на случай ошибки отправки
                setTimeout(() => {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalHTML;
                }, 5000);
            });

            // Плавное появление вопросов
            const questionCards = document.querySelectorAll('.question-card');
            questionCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';

                setTimeout(() => {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100 * index);
            });
        });
    </script>
</body>
</html>